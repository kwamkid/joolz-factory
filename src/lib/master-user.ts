// src/lib/master-user.ts
import { doc, getDoc, setDoc } from 'firebase/firestore';
import { createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'firebase/auth';
import { auth, db } from '@/lib/firebase';
import { User } from '@/types';

// Master User Configuration
const MASTER_USER = {
  email: 'admin@joolzfactory.com',
  password: 'JoolzFactory2024!',
  name: 'Admin Joolz Factory',
  lineId: 'master-admin-joolz',
  roles: ['operation', 'manager', 'admin'] as const,
};

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Master User ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô setup)
 */
export async function createMasterUser() {
  try {
    console.log('üîß Creating master user...');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Firebase Auth account
    const userCredential = await createUserWithEmailAndPassword(
      auth,
      MASTER_USER.email,
      MASTER_USER.password
    );
    
    const firebaseUser = userCredential.user;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á User document ‡πÉ‡∏ô Firestore
    const masterUserData: Omit<User, 'id'> = {
      lineId: MASTER_USER.lineId,
      name: MASTER_USER.name,
      roles: [...MASTER_USER.roles],
      isActive: true,
      createdAt: new Date(),
      pictureUrl: undefined,
      phone: undefined,
    };
    
    await setDoc(doc(db, 'users', firebaseUser.uid), masterUserData);
    
    console.log('‚úÖ Master user created successfully!');
    console.log('üìß Email:', MASTER_USER.email);
    console.log('üîë Password:', MASTER_USER.password);
    
    return firebaseUser;
    
  } catch (error: any) {
    if (error.code === 'auth/email-already-in-use') {
      console.log('‚ÑπÔ∏è Master user already exists');
      return await signInWithEmailAndPassword(auth, MASTER_USER.email, MASTER_USER.password);
    }
    console.error('‚ùå Error creating master user:', error);
    throw error;
  }
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Master User ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
export async function checkMasterUserExists(): Promise<boolean> {
  try {
    await signInWithEmailAndPassword(auth, MASTER_USER.email, MASTER_USER.password);
    return true;
  } catch {
    return false;
  }
}

/**
 * Login ‡πÄ‡∏õ‡πá‡∏ô Master User
 */
export async function loginAsMasterUser() {
  try {
    const userCredential = await signInWithEmailAndPassword(
      auth,
      MASTER_USER.email,
      MASTER_USER.password
    );
    
    return userCredential.user;
  } catch (error) {
    console.error('‚ùå Master user login failed:', error);
    throw new Error('Master user login failed');
  }
}

/**
 * Auto-setup Master User ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏û‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
 */
export async function autoSetupMasterUser() {
  const exists = await checkMasterUserExists();
  
  if (!exists) {
    console.log('üöÄ Setting up master user for first time...');
    await createMasterUser();
  }
  
  return exists;
}

// Export master user credentials for development
export const MASTER_CREDENTIALS = {
  email: MASTER_USER.email,
  password: MASTER_USER.password,
};