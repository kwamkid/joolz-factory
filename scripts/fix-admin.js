// scripts/fix-admin.js
const { initializeApp, cert } = require("firebase-admin/app");
const { getAuth } = require("firebase-admin/auth");
const { getFirestore } = require("firebase-admin/firestore");
require("dotenv").config({ path: ".env.local" });

// Initialize Firebase Admin
const app = initializeApp({
  credential: cert({
    projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
    clientEmail: process.env.FIREBASE_ADMIN_CLIENT_EMAIL,
    privateKey: process.env.FIREBASE_ADMIN_PRIVATE_KEY.replace(/\\n/g, "\n"),
  }),
});

const auth = getAuth();
const db = getFirestore();

async function fixAdminUser() {
  const adminEmail = "admin@joolzfactory.com";
  const adminUid = "X6bMpc5JzBOz2nL1OjuUBypYLi32"; // UID ‡∏à‡∏≤‡∏Å list users
  const newPassword = "MKthailand47";

  try {
    console.log("üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Admin User...\n");

    // 1. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Auth User
    await auth.updateUser(adminUid, {
      displayName: "System Admin",
      emailVerified: true,
      password: newPassword,
    });
    console.log("‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Auth User ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Firestore Document
    await db.collection("users").doc(adminUid).set(
      {
        email: adminEmail,
        name: "System Admin",
        role: "admin",
        isSystemAdmin: true,
        createdAt: new Date(),
        updatedAt: new Date(),
      },
      { merge: true }
    );
    console.log("‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Firestore Document ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    // 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç kwamkid user ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
    const kwamkidUid = "j83doLGkBgOLujmwqYUcYBYPWWC2";
    try {
      const kwamkidUser = await auth.getUser(kwamkidUid);

      await db
        .collection("users")
        .doc(kwamkidUid)
        .set(
          {
            email: kwamkidUser.email,
            name: kwamkidUser.displayName || "Kwamkid User",
            role: "manager", // ‡∏´‡∏£‡∏∑‡∏≠ 'operation' ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            createdAt: new Date(),
            updatedAt: new Date(),
          },
          { merge: true }
        );

      console.log("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Firestore Document ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö kwamkid@gmail.com");
    } catch (error) {
      console.log("‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó kwamkid user");
    }

    console.log("\n‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!");
    console.log("\nüîê Admin Login Credentials:");
    console.log("Email:", adminEmail);
    console.log("Password:", newPassword);
    console.log("\nüí° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö login ‡∏î‡πâ‡∏ß‡∏¢: npm run test:firebase");
  } catch (error) {
    console.error("‚ùå Error:", error.message);
  }

  process.exit();
}

fixAdminUser();
